<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WoW Classic / TBC ‚Äì Hurensohnliste</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<style>
body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f5e6c8;
  background:url('https://bnetcmsus-a.akamaihd.net/cms/blog_header/15/154R55EBRA3S1763416975589.png') no-repeat center center fixed;
  background-size:cover;
}
.container{
  max-width:900px;
  margin:20px auto;
  padding:25px;
  background:linear-gradient(145deg, rgba(15,10,5,0.95), rgba(25,18,10,0.92));
  border:4px solid #c9a44c;
  border-image:linear-gradient(45deg, #c9a44c, #ffd36a, #c9a44c) 1;
  border-radius:18px;
  box-shadow:0 0 40px rgba(201,164,76,0.5), inset 0 0 20px rgba(0,0,0,0.8);
  position:relative;
}
.container::before{
  content:'';
  position:absolute;
  top:-10px; left:-10px; right:-10px; bottom:-10px;
  background:linear-gradient(45deg, transparent 49%, rgba(201,164,76,0.15) 50%, transparent 51%);
  border-radius:25px;
  z-index:-1;
}
h1{
  text-align:center;
  color:#ffd36a;
  text-shadow:0 0 20px rgba(255,211,106,0.9), 2px 2px 6px rgba(0,0,0,1);
  font-size:2.4em;
  margin:0 0 30px 0;
  letter-spacing:4px;
  position:relative;
}
h1::after{
  content:'Schande den Hurens√∂hnen!';
  display:block;
  font-size:0.5em;
  color:#d4af37;
  letter-spacing:2px;
  margin-top:8px;
  opacity:0.8;
}
input,select,textarea{
  padding:12px 16px;
  background:linear-gradient(145deg, #2a1f12, #1a1208);
  border:2px solid #8c6a32;
  color:#f5e6c8;
  border-radius:10px;
  font-family:inherit;
  font-size:14px;
  box-shadow:inset 0 3px 6px rgba(0,0,0,0.7);
  text-shadow:1px 1px 2px rgba(0,0,0,0.9);
  transition:all 0.3s ease;
  box-sizing:border-box;
}
textarea{ resize:vertical; min-height:80px; }
input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:#ffd36a;
  box-shadow:0 0 15px rgba(255,211,106,0.6), inset 0 1px 0 rgba(255,255,255,0.2);
}
button{
  cursor:pointer;
  font-family:'Cinzel',serif;
  font-weight:700;
  position:relative;
  overflow:hidden;
  transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
  text-transform:uppercase;
  letter-spacing:1.5px;
}
button::before{
  content:'';
  position:absolute;
  top:0; left:-100%;
  width:100%; height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transition:left 0.6s;
}
button:hover::before{left:100%;}
button:hover{transform:translateY(-3px) scale(1.02);}
.btn-wow{
  background:linear-gradient(145deg, #d4af37, #b8942f, #8c6a32);
  color:#1a0f06;
  border:3px solid #ffd36a;
  border-radius:12px;
  padding:10px 20px;
  font-size:13px;
  box-shadow:0 6px 20px rgba(212,175,55,0.5), inset 0 2px 0 rgba(255,255,255,0.4);
  text-shadow:0 1px 2px rgba(255,255,255,0.6);
  min-width:140px;
}
.btn-wow:hover{
  background:linear-gradient(145deg, #ffd36a, #e0b75a, #c9a44c);
  box-shadow:0 10px 25px rgba(212,175,55,0.7);
  border-color:#ffeb8a;
}
.btn-action{
  width:32px; height:32px;
  padding:0;
  border-radius:8px;
  font-size:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(145deg, #c79c6e, #a87d4e);
  border:3px solid #d4af37;
  color:#2a1f12;
  box-shadow:0 4px 15px rgba(199,156,110,0.5);
  transition:all 0.2s ease;
}
.btn-action:hover{
  background:linear-gradient(145deg, #d4af37, #c79c6e);
  box-shadow:0 7px 20px rgba(199,156,110,0.7);
  transform:scale(1.1);
}
.btn-danger{
  background:linear-gradient(145deg, #8c3a2f, #6b2e24) !important;
  border-color:#d44a37 !important;
  color:#f5e6c8 !important;
}
#loginPanel{
  max-width:500px;
  margin:0 auto 35px;
  padding:35px;
  background:linear-gradient(145deg, #1f150d, #120a06);
  border:4px solid #8c6a32;
  border-radius:20px;
  box-shadow:0 12px 35px rgba(0,0,0,0.9), inset 0 2px 0 rgba(255,255,255,0.15);
  text-align:center;
}
.form,.filters{
  display:flex;
  flex-wrap:wrap;
  gap:15px;
  margin-bottom:20px;
  padding:20px;
  background:rgba(26,18,8,0.5);
  border-radius:15px;
  border:2px solid rgba(140,106,50,0.4);
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.5);
}
.form-full{width:100%;}
#crime{flex:1;min-width:100%;}
.form-buttons{
  display:flex;
  justify-content:center;
  gap:20px;
  margin-top:20px;
}
#indexPanel{
  margin:20px 0;
  padding:25px;
  background:linear-gradient(145deg, rgba(26,18,8,0.7), rgba(15,10,5,0.7));
  border:3px solid #c9a44c;
  border-radius:18px;
  box-shadow:0 8px 25px rgba(0,0,0,0.6);
}
.stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin:20px 0;
}
.stat-card{
  background:linear-gradient(145deg,#2a1f12,#1a1208);
  padding:25px 15px;
  border-radius:15px;
  border:3px solid #8c6a32;
  text-align:center;
  transition:all 0.3s ease;
  position:relative;
  overflow:hidden;
}
.stat-card::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background:linear-gradient(145deg, transparent, rgba(255,211,106,0.1), transparent);
  opacity:0;
  transition:opacity 0.3s;
}
.stat-card:hover::before{opacity:1;}
.stat-card:hover{transform:translateY(-5px);}
.stat-number{
  font-size:2.8em;
  font-weight:800;
  color:#ffd36a;
  text-shadow:2px 2px 6px rgba(0,0,0,1);
  display:block;
  line-height:1;
}
.stat-label{
  color:#d4af37;
  font-size:14px;
  margin-top:8px;
  font-weight:500;
  text-transform:uppercase;
  letter-spacing:1px;
}
#list{
  margin-top:30px;
  display:block;
}
.entry{
  display:flex;
  flex-direction:column;
  width:100%;
  max-width:850px;
  margin:0 auto 22px auto;
  background:linear-gradient(145deg, #2a1f12, #1a1208, #120a06);
  border:4px solid #8c6a32;
  border-left:12px solid;
  border-radius:20px;
  padding:22px;
  box-shadow:0 12px 35px rgba(0,0,0,0.9), inset 0 2px 0 rgba(255,255,255,0.08);
  position:relative;
  transition:all 0.4s cubic-bezier(0.4,0,0.2,1);
  word-wrap:break-word;
  hyphens:auto;
}
.entry::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0;
  height:6px;
  background:linear-gradient(90deg, transparent, #ffd36a, #d4af37, #ffd36a, transparent);
  border-radius:20px 20px 0 0;
  box-shadow:0 2px 8px rgba(255,211,106,0.4);
}
.entry:hover{
  transform:translateY(-8px) scale(1.01);
  box-shadow:0 20px 45px rgba(201,164,76,0.4), inset 0 2px 0 rgba(255,255,255,0.12);
}
.entry-top{
  display:flex;
  align-items:flex-start;
  gap:18px;
}
.icon-row{
  display:flex;
  gap:8px;
}
.icon{
  width:42px;
  height:42px;
  background-size:cover;
  background-position:center;
  border:4px solid #c9a44c;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.7);
  position:relative;
}
.icon::after{
  content:'';
  position:absolute;
  bottom:-4px; right:-4px;
  width:14px; height:14px;
  background:#ffd36a;
  border-radius:50%;
  box-shadow:0 3px 8px rgba(0,0,0,0.5);
}
.entry-body{
  flex:1;
  color:#f5e6c8;
  margin-left:15px;
  min-width:0;
}
.entry-name{
  font-weight:800;
  font-size:18px;
  color:#ffd36a;
  text-shadow:2px 2px 4px rgba(0,0,0,1);
  margin-bottom:6px;
  letter-spacing:1px;
}
.entry-info{
  font-size:13px;
  color:#d4af37;
  margin-bottom:10px;
  text-shadow:1px 1px 3px rgba(0,0,0,0.9);
  font-weight:500;
}
.entry-crime{
  font-size:14px;
  line-height:1.5;
  color:#f0e6d2;
  padding:12px 0;
  border-left:4px solid rgba(140,106,50,0.6);
  padding-left:18px;
  background:rgba(255,255,255,0.03);
  border-radius:8px;
  word-wrap:break-word;
}
.voteBox{
  display:flex;
  align-items:center;
  gap:8px;
  position:absolute;
  top:15px;
  right:20px;
  background:linear-gradient(145deg, rgba(26,18,8,0.95), rgba(15,10,5,0.95));
  padding:12px 16px;
  border-radius:15px;
  border:3px solid #6b4e31;
  box-shadow:0 6px 20px rgba(0,0,0,0.8);
}
.voteBtn{
  font-size:22px;
  cursor:pointer;
  opacity:0.8;
  transition:all 0.25s ease;
  padding:6px;
  border-radius:10px;
  transition:transform 0.1s ease;
}
.voteBtn:hover{
  transform:scale(1.25);
  opacity:1;
  background:rgba(255,255,255,0.15);
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
}
.voteBtn:active{
  transform:scale(0.95);
}
.voteCount{
  min-width:26px;
  text-align:center;
  font-size:15px;
  font-weight:700;
  color:#ffd36a;
  text-shadow:1px 1px 2px rgba(0,0,0,1);
}
.entry-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:15px;
  padding-top:15px;
  border-top:3px solid rgba(140,106,50,0.5);
  background:rgba(255,255,255,0.02);
  border-radius:0 0 12px 12px;
}
.modal{
  position:fixed;
  top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.9);
  z-index:10000;
  display:flex;
  align-items:center;
  justify-content:center;
}
.modal-content{
  background:linear-gradient(145deg,#2a1f12,#1a1208);
  border:4px solid #c9a44c;
  border-radius:20px;
  padding:30px;
  max-width:90%;
  max-height:90vh;
  overflow:auto;
  color:#f5e6c8;
  position:relative;
  max-width:500px;
  width:90%;
}
.modal-close{
  position:absolute;
  top:15px; right:25px;
  font-size:28px;
  color:#ffd36a;
  cursor:pointer;
  font-weight:bold;
}
.modal-close:hover{color:#fff;}
.modal input, .modal select, .modal textarea{
  width:100%;
  margin:10px 0;
  padding:12px;
  background:#1a1208;
  border:2px solid #8c6a32;
  color:#f5e6c8;
  border-radius:10px;
  font-family:inherit;
  box-sizing:border-box;
}
.modal textarea{min-height:120px;}
.modal-buttons{
  display:flex;
  gap:15px;
  justify-content:flex-end;
  margin-top:25px;
}
#adminPanel{
  margin-top:30px;
  background:linear-gradient(145deg, #2a1f12, #1a1208);
  padding:22px;
  border-radius:16px;
  border:4px solid #8c6a32;
  box-shadow:0 12px 35px rgba(0,0,0,0.9);
  display:none;
}
.adminUser{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
  padding:15px;
  background:rgba(41,31,18,0.7);
  border-radius:12px;
  border-left:6px solid #c9a44c;
  box-shadow:0 4px 15px rgba(0,0,0,0.5);
}
#updateHistory{
  margin-top:30px;
  background:linear-gradient(145deg, #1f150d, #120a06);
  padding:22px;
  border-radius:16px;
  border:4px solid #6b4e31;
  max-height:250px;
  overflow-y:auto;
  font-size:13px;
  box-shadow:0 12px 35px rgba(0,0,0,0.9);
}
#updateHistory::-webkit-scrollbar{
  width:10px;
}
#updateHistory::-webkit-scrollbar-track{
  background:rgba(26,18,8,0.5);
  border-radius:5px;
}
#updateHistory::-webkit-scrollbar-thumb{
  background:linear-gradient(#c9a44c, #ffd36a);
  border-radius:5px;
}
#updateHistory div{
  padding:8px 0;
  border-bottom:1px solid rgba(140,106,50,0.3);
}
#updateHistory strong{
  color:#ffd36a;
  text-shadow:1px 1px 2px rgba(0,0,0,1);
}
@media(max-width:768px){
  .container{max-width:95%; margin:10px auto; padding:15px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .form,.filters{flex-direction:column;}
}
</style>
</head>
<body>
<div class="container">
  <h1>WoW Classic / TBC ‚Äì Schandtatenliste</h1>

  <!-- üÜï INDEX/√úBERSICHT -->
  <div id="indexPanel" style="display:none;">
    <h3 style="color:#ffd36a; margin:0 0 25px 0; text-align:center; text-shadow:2px 2px 4px #000;">
      üìä Schlachten√ºbersicht
    </h3>
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-number" id="totalEntries">0</span>
        <span class="stat-label">Schandtaten</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalVotes">0</span>
        <span class="stat-label">Stimmen</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="topRace">-</span>
        <span class="stat-label">Schlechteste Rasse</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="topClass">-</span>
        <span class="stat-label">Schlechteste Klasse</span>
      </div>
    </div>
    <div style="text-align:center; margin-top:20px;">
      <button id="showAllBtn" class="btn-wow">‚öîÔ∏è Alle Schandtaten anzeigen</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginPanel">
    <input type="email" id="email" placeholder="Email-Adresse"><br><br>
    <input type="password" id="password" placeholder="Passwort"><br><br>
    <div class="form-buttons">
      <button id="registerBtn" class="btn-wow">Registieren</button>
      <button id="loginBtn" class="btn-wow">Login</button>
    </div>
  </div>

  <!-- HAUPTINHALT -->
  <div id="mainContent" style="display:none;">
    <div class="filters">
      <input id="search" placeholder="Namen oder Schandtat...">
      <select id="filterRace">
        <option value="">üè∞ Alle Rassen</option>
        <option>Mensch</option><option>Zwerg</option><option>Nachtelf</option>
        <option>Gnom</option><option>Draenei</option>
        <option>Ork</option><option>Troll</option><option>Tauren</option>
        <option>Untoter</option><option>Blutelf</option>
      </select>
      <select id="filterClass">
        <option value="">‚öîÔ∏è Alle Klassen</option>
        <option>Krieger</option><option>Paladin</option><option>J√§ger</option>
        <option>Schurke</option><option>Priester</option>
        <option>Schamane</option><option>Magier</option>
        <option>Hexenmeister</option><option>Druide</option>
      </select>
    </div>

    <div class="form">
      <input id="name" placeholder="Name des Sch√§nders">
      <select id="race">
        <option value="">Rasse w√§hlen</option>
        <option>Mensch</option><option>Zwerg</option><option>Nachtelf</option>
        <option>Gnom</option><option>Draenei</option>
        <option>Ork</option><option>Troll</option><option>Tauren</option>
        <option>Untoter</option><option>Blutelf</option>
      </select>
      <select id="wowClass">
        <option value="">Klasse w√§hlen</option>
        <option>Krieger</option><option>Paladin</option><option>J√§ger</option>
        <option>Schurke</option><option>Priester</option>
        <option>Schamane</option><option>Magier</option>
        <option>Hexenmeister</option><option>Druide</option>
      </select>
    </div>
    <div class="form-full">
      <textarea id="crime" placeholder="Die Schandtat beschreiben..."></textarea>
    </div>
    <div class="form-buttons">
      <button id="addBtn" class="btn-wow">Schandtat melden</button>
      <button id="logoutBtn" class="btn-wow">Ausloggen</button>
    </div>

    <div id="list"></div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel">
      <h3 style="color:#ffd36a;margin:0 0 20px 0;text-shadow:2px 2px 4px black;">‚õ® Rekruten freischalten</h3>
      <div id="pendingList"></div>
    </div>

    <!-- UPDATE HISTORY -->
    <div id="updateHistory">
      <strong>üìú Schlachtchronik:</strong>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, getDocs, updateDoc, deleteDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBOko8Wg-jCvz7aRPleNcbJCm8u2CYtjps",
  authDomain:"wow-hs-liste.firebaseapp.com",
  projectId:"wow-hs-liste",
  storageBucket:"wow-hs-liste.appspot.com",
  messagingSenderId:"180764359810",
  appId:"1:180764359810:web:03cef19546dcc32081889b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const initialClassData = {
  Krieger:{color:"#C79C6E",icon:"https://wow.zamimg.com/images/wow/icons/large/class_warrior.jpg"},
  Magier:{color:"#69CCF0",icon:"https://wow.zamimg.com/images/wow/icons/large/class_mage.jpg"},
  Priester:{color:"#FFFFFF",icon:"https://wow.zamimg.com/images/wow/icons/large/class_priest.jpg"},
  Schurke:{color:"#FFF569",icon:"https://wow.zamimg.com/images/wow/icons/large/class_rogue.jpg"},
  J√§ger:{color:"#ABD473",icon:"https://wow.zamimg.com/images/wow/icons/large/class_hunter.jpg"},
  Hexenmeister:{color:"#9482C9",icon:"https://wow.zamimg.com/images/wow/icons/large/class_warlock.jpg"},
  Druide:{color:"#FF7D0A",icon:"https://wow.zamimg.com/images/wow/icons/large/class_druid.jpg"},
  Paladin:{color:"#F58CBA",icon:"https://wow.zamimg.com/images/wow/icons/large/class_paladin.jpg"},
  Schamane:{color:"#0070DE",icon:"https://wow.zamimg.com/images/wow/icons/large/class_shaman.jpg"}
};

const raceIcons = {
  Mensch:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_human_male.jpg",
  Zwerg:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_dwarf_male.jpg",
  Nachtelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_nightelf_male.jpg",
  Gnom:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_gnome_male.jpg",
  Draenei:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_draenei_male.jpg",
  Ork:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_orc_male.jpg",
  Troll:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_troll_male.jpg",
  Tauren:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_tauren_male.jpg",
  Untoter:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_undead_male.jpg",
  Blutelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_bloodelf_male.jpg"
};

// DOM Elements
const email = document.getElementById("email");
const password = document.getElementById("password");
const loginPanel = document.getElementById("loginPanel");
const mainContent = document.getElementById("mainContent");
const list = document.getElementById("list");
const nameInput = document.getElementById("name");
const race = document.getElementById("race");
const wowClass = document.getElementById("wowClass");
const crimeInput = document.getElementById("crime");
const adminPanel = document.getElementById("adminPanel");
const pendingList = document.getElementById("pendingList");
const updateHistory = document.getElementById("updateHistory");
const searchInput = document.getElementById("search");
const filterRace = document.getElementById("filterRace");
const filterClass = document.getElementById("filterClass");
const indexPanel = document.getElementById("indexPanel");

let entries = [];
let currentUserRole = '';

// REGISTER/LOGIN/LOGOUT
document.getElementById("registerBtn").onclick = async () => {
  try {
    const cred = await createUserWithEmailAndPassword(auth, email.value, password.value);
    await setDoc(doc(db, "users", cred.user.uid), {email: email.value, role: "pending"});
    alert("‚úÖ Registriert! Der Gro√üverwalter muss dich freischalten.");
    signOut(auth);
  } catch(e) {
    alert("‚ùå Fehler: " + e.message);
  }
};

document.getElementById("loginBtn").onclick = () =>
  signInWithEmailAndPassword(auth, email.value, password.value).catch(e => alert("‚ùå " + e.message));

document.getElementById("logoutBtn").onclick = () => signOut(auth);

// AUTH STATE CHANGE
onAuthStateChanged(auth, async user => {
  if(!user) {
    loginPanel.style.display = "block";
    mainContent.style.display = "none";
    indexPanel.style.display = "none";
    return;
  }
  
  const snap = await getDoc(doc(db, "users", user.uid));
  if(!snap.exists() || snap.data().role === "pending") {
    alert("‚è≥ Noch nicht freigeschaltet! Warte auf den Gro√üverwalter.");
    signOut(auth);
    return;
  }
  
  currentUserRole = snap.data().role;
  loginPanel.style.display = "none";
  mainContent.style.display = "block";
  indexPanel.style.display = "block";
  
  if(currentUserRole === "admin") {
    adminPanel.style.display = "block";
    loadPending();
  } else {
    adminPanel.style.display = "none";
  }
  
  loadEntries();
});

// ADD ENTRY
document.getElementById("addBtn").onclick = async () => {
  const user = auth.currentUser;
  if(!user || !nameInput.value || !race.value || !wowClass.value || !crimeInput.value) {
    alert("‚ö†Ô∏è Alle Felder ausf√ºllen, Schandtat!");
    return;
  }
  try {
    await addDoc(collection(db, "entries"), {
      uid: user.uid,
      name: nameInput.value,
      race: race.value,
      class: wowClass.value,
      crime: crimeInput.value,
      upvotes: 0,
      downvotes: 0,
      createdAt: serverTimestamp()
    });
    appendUpdate(`‚öîÔ∏è Schandtat gemeldet: ${nameInput.value}`);
    nameInput.value = ""; race.value = ""; wowClass.value = ""; crimeInput.value = "";
  } catch(e) {
    alert("‚ùå Fehler beim Melden: " + e.message);
  }
};

// UPDATE HISTORY
function appendUpdate(text) {
  const p = document.createElement("div");
  p.innerText = `${new Date().toLocaleString('de-DE')}: ${text}`;
  updateHistory.appendChild(p);
  updateHistory.scrollTop = updateHistory.scrollHeight;
}

// LOAD ENTRIES
function loadEntries() {
  const q = query(collection(db, "entries"), orderBy("createdAt", "desc"));
  onSnapshot(q, snap => {
    entries = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderEntries();
    updateIndex();
  });
}

// üÜï INDEX/STATISTICS
function updateIndex() {
  if(entries.length === 0) return;
  
  document.getElementById('totalEntries').textContent = entries.length;
  
  const totalVotes = entries.reduce((sum, e) => sum + (e.upvotes || 0) + (e.downvotes || 0), 0);
  document.getElementById('totalVotes').textContent = totalVotes;
  
  const raceStats = {};
  entries.forEach(e => {
    raceStats[e.race] = (raceStats[e.race] || 0) + 1;
  });
  const worstRace = Object.entries(raceStats).reduce((a, b) => a[1] > b[1] ? a : b, ['', 0])[0];
  document.getElementById('topRace').textContent = worstRace || '-';
  
  const classStats = {};
  entries.forEach(e => {
    classStats[e.class] = (classStats[e.class] || 0) + 1;
  });
  const worstClass = Object.entries(classStats).reduce((a, b) => a[1] > b[1] ? a : b, ['', 0])[0];
  document.getElementById('topClass').textContent = worstClass || '-';
}

// RENDER ENTRIES
function renderEntries() {
  const term = (searchInput.value || "").toLowerCase();
  const fr = filterRace.value;
  const fc = filterClass.value;

  list.innerHTML = "";
  
  entries
    .filter(e =>
      (!fr || e.race === fr) &&
      (!fc || e.class === fc) &&
      (!term || 
        e.name.toLowerCase().includes(term) ||
        e.crime.toLowerCase().includes(term))
    )
    .forEach(data => {
      const div = document.createElement("div");
      div.className = "entry";
      div.id = "entry-" + data.id;
      div.style.borderLeftColor = initialClassData[data.class]?.color || "#8c6a32";

      div.innerHTML = `
        <div class="entry-top">
          <div class="icon-row">
            <div class="icon" style="background-image:url('${raceIcons[data.race] || ''}')"></div>
            <div class="icon" style="background-image:url('${initialClassData[data.class]?.icon || ''}')"></div>
          </div>
          <div class="entry-body">
            <div class="entry-name">${data.name}</div>
            <div class="entry-info">${data.race} / ${data.class} | üëç${data.upvotes || 0} üëé${data.downvotes || 0}</div>
            <div class="entry-crime">Schandtat: ${data.crime}</div>
          </div>
          <div class="voteBox">
            <span class="voteBtn" id="up-${data.id}">üëç</span>
            <span class="voteCount" id="upc-${data.id}">${data.upvotes || 0}</span>
            <span class="voteBtn" id="down-${data.id}">üëé</span>
            <span class="voteCount" id="downc-${data.id}">${data.downvotes || 0}</span>
          </div>
        </div>
        ${currentUserRole ? `
        <div class="entry-actions">
          <button id="edit-${data.id}" class="btn-action" title="Bearbeiten">‚úèÔ∏è</button>
          <button id="del-${data.id}" class="btn-action btn-danger" title="L√∂schen">üóëÔ∏è</button>
        </div>
        ` : ''}
      `;

      list.appendChild(div);

      // Event Handlers
      if(document.getElementById("up-" + data.id)) {
        document.getElementById("up-" + data.id).onclick = () => vote(data.id, "up");
        document.getElementById("down-" + data.id).onclick = () => vote(data.id, "down");
      }
      
      if(currentUserRole) {
        if(document.getElementById("edit-" + data.id)) {
          document.getElementById("edit-" + data.id).onclick = () => showEditModal(data);
        }
        if(document.getElementById("del-" + data.id)) {
          document.getElementById("del-" + data.id).onclick = () => confirmDelete(data.id);
        }
      }
    });
}

// VOTE SYSTEM
async function vote(id, type) {
  const user = auth.currentUser;
  if(!user) {
    alert("‚öîÔ∏è Tritt der Horde bei! (Login erforderlich)");
    return;
  }
  
  const voteRef = doc(db, "entries", id, "votes", user.uid);
  const entryRef = doc(db, "entries", id);
  const snap = await getDoc(voteRef);

  try {
    if(!snap.exists()) {
      await setDoc(voteRef, {type});
      await updateDoc(entryRef, {
        [type === 'up' ? 'upvotes' : 'downvotes']: increment(1)
      });
    } else {
      const old = snap.data().type;
      if(old === type) return;
      await updateDoc(voteRef, {type});
      await updateDoc(entryRef, {
        [old === 'up' ? 'upvotes' : 'downvotes']: increment(-1),
        [type === 'up' ? 'upvotes' : 'downvotes']: increment(1)
      });
    }
  } catch(e) {
    alert("‚ùå Voting-Fehler: " + e.message);
  }
}

// üÜï EDIT MODAL
function showEditModal(data) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <span class="modal-close" onclick="document.querySelector('.modal').remove()">√ó</span>
      <h3 style="color:#ffd36a; margin:0 0 25px 0; text-shadow:2px 2px 4px #000;">‚úèÔ∏è Schandtat bearbeiten</h3>
      <input id="editName" value="${data.name}" placeholder="Name des Sch√§nders">
      <select id="editRace">
        ${Object.keys(raceIcons).map(r => `<option ${r === data.race ? 'selected' : ''}>${r}</option>`).join('')}
      </select>
      <select id="editClass">
        ${Object.keys(initialClassData).map(c => `<option ${c === data.class ? 'selected' : ''}>${c}</option>`).join('')}
      </select>
      <textarea id="editCrime" placeholder="Die Schandtat beschreiben...">${data.crime}</textarea>
      <div class="modal-buttons">
        <button class="btn-wow" onclick="saveEdit('${data.id}')">üíæ</button>
        <button class="btn-action btn-danger" onclick="document.querySelector('.modal').remove()">‚ùå</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  modal.onkeydown = (e) => {
    if(e.key === 'Escape') modal.remove();
  };
  modal.querySelector('#editName').focus();
}

// üÜï SAVE EDIT
window.saveEdit = async function(id) {
  const modal = document.querySelector('.modal');
  const newName = modal.querySelector('#editName').value;
  const newRace = modal.querySelector('#editRace').value;
  const newClass = modal.querySelector('#editClass').value;
  const newCrime = modal.querySelector('#editCrime').value;
  
  if(newName && newRace && newClass && newCrime) {
    try {
      await updateDoc(doc(db, "entries", id), {
        name: newName,
        race: newRace,
        class: newClass,
        crime: newCrime,
        role: initialClassData[newClass]?.role || ""
      });
      appendUpdate(`‚úèÔ∏è Schandtat bearbeitet: ${newName}`);
      modal.remove();
    } catch(e) {
      alert("‚ùå Speicherfehler: " + e.message);
    }
  } else {
    alert("‚ö†Ô∏è Alle Felder ausf√ºllen!");
  }
};

// üÜï CONFIRM DELETE
window.confirmDelete = async function(id) {
  if(confirm("üóëÔ∏è Diese Schandtat wirklich aus dem Archiv tilgen?\n\nEintrag-ID: " + id)) {
    try {
      await deleteDoc(doc(db, "entries", id));
      appendUpdate(`üóëÔ∏è Schandtat gel√∂scht (ID: ${id})`);
    } catch(e) {
      alert("‚ùå L√∂schfehler: " + e.message);
    }
  }
};

// FILTER EVENTS
searchInput.addEventListener("input", renderEntries);
filterRace.addEventListener("change", renderEntries);
filterClass.addEventListener("change", renderEntries);

// SHOW ALL BUTTON
document.getElementById('showAllBtn').onclick = () => {
  searchInput.value = '';
  filterRace.value = '';
  filterClass.value = '';
  renderEntries();
};

// ADMIN FUNCTIONS
async function loadPending() {
  pendingList.innerHTML = "";
  const snaps = await getDocs(collection(db, "users"));
  let count = 0;
  
  snaps.forEach(d => {
    const u = d.data();
    if(u.role === "pending") {
      count++;
      const div = document.createElement("div");
      div.className = "adminUser";
      div.innerHTML = `
        ${u.email} 
        <button class="btn-wow" style="padding:8px 16px; font-size:12px;" onclick="approveUser('${d.id}')">‚úÖ Freischalten</button>
      `;
      pendingList.appendChild(div);
    }
  });
  
  if(count === 0) {
    pendingList.innerHTML = '<div style="text-align:center; color:#d4af37; padding:20px;">üéâ Keine wartenden Rekruten</div>';
  }
}

window.approveUser = async function(uid) {
  try {
    await updateDoc(doc(db, "users", uid), {role: "user"});
    loadPending();
    appendUpdate(`‚úÖ K√§mpfer freigeschaltet: ${uid}`);
  } catch(e) {
    alert("‚ùå Freischaltfehler: " + e.message);
  }
};
</script>
</body>
</html>

