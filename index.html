<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WoW Classic / TBC ‚Äì Schandtatenliste</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<style>
html,body{margin:0;font-family:'Cinzel',serif;background:linear-gradient(rgba(0,0,0,.55),rgba(0,0,0,.85)),url('https://blz-contentstack-images.akamaized.net/v3/assets/bltf408a0557f4e4998/blt6a80c8e7260f84f2/690d2219b415dd246153245b/BCC.png');background-size:cover;background-attachment:fixed;color:#f5e6c8;}
.container{max-width:1350px;margin:40px auto;padding:30px;background:rgba(15,10,5,.92);border:6px solid #c9a44c;border-radius:16px;box-shadow:0 0 40px #000;}
h1{text-align:center;color:#ffd36a;}
input,select,button{padding:10px;background:#120c05;border:2px solid #9c7c3f;color:#f5e6c8;border-radius:6px;font-family:inherit;}
button{cursor:pointer;background:linear-gradient(#e7c26a,#8a6b2f);color:#1b1206;font-weight:bold;}
button:hover{filter:brightness(1.15);}
#loginPanel{max-width:400px;margin:40px auto;background:#1a1208;padding:20px;border-radius:14px;box-shadow:0 0 25px #000;}
#mainContent{display:none;}
.filters,.form{display:flex;gap:10px;flex-wrap:wrap;}
.form-full{margin-top:10px;width:100%;}
#crime{width:100%;}
.entry{display:grid;grid-template-columns:44px 44px 1fr 180px;gap:12px;align-items:center;padding:12px;margin-bottom:12px;background:linear-gradient(#1a1208,#0d0904);border:2px solid #8c6a32;border-left:8px solid;border-radius:10px;}
.icon{width:40px;height:40px;background-size:cover;background-position:center;border:2px solid #c9a44c;border-radius:4px;}
.voteBox{display:flex;flex-direction:column;gap:4px;}
.voteRow{display:flex;gap:6px;align-items:center;}
.editRow{display:flex;gap:6px;margin-top:4px;}
.editRow button{font-size:12px;padding:3px 6px;}
.voteBtn{cursor:pointer;font-size:20px;opacity:.4;transition:.15s;}
.voteBtn:hover{transform:scale(1.25);opacity:1;}
.voteBtn.active.up{color:#4CAF50;opacity:1;}
.voteBtn.active.down{color:#E53935;opacity:1;}
#adminPanel,#historyPanel{margin-top:20px;padding:10px;background:#1a1208;border:2px solid #8c6a32;border-radius:10px;}
</style>
</head>
<body>
<div class="container">
<h1>WoW Classic / TBC ‚Äì Schandtatenliste</h1>

<!-- LOGIN -->
<div id="loginPanel">
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Passwort"><br><br>
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Registrieren</button>
</div>

<!-- MAIN -->
<div id="mainContent">
<div class="filters">
  <input id="search" placeholder="Suche">
  <select id="filterRace"><option value="">Alle Rassen</option></select>
  <select id="filterClass"><option value="">Alle Klassen</option></select>
</div>

<div class="form">
  <input id="name" placeholder="Name">
  <select id="race"></select>
  <select id="wowClass"></select>
</div>

<div class="form-full">
  <input id="crime" placeholder="Schandtat">
</div>

<div style="text-align:center;margin-top:10px">
  <button id="addBtn">Hinzuf√ºgen</button>
  <button id="logoutBtn">Logout</button>
</div>

<div id="list"></div>

<div id="adminPanel" style="display:none">
  <h3>Pending User</h3>
  <div id="pendingList"></div>
</div>

<div id="historyPanel">
  <h3>Update-Historie</h3>
  <ul>
    <li>1.0 ‚Äì Initiale Version</li>
    <li>1.1 ‚Äì Live Voting + Sounds</li>
    <li>1.2 ‚Äì Admin Panel</li>
    <li>1.3 ‚Äì TBC Hintergrund + Tooltips</li>
    <li>1.4 ‚Äì Voting-Fix: maximal 1 Vote pro User</li>
  </ul>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, increment, serverTimestamp, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig={
  apiKey:"AIzaSyBOko8Wg-jCvz7aRPleNcbJCm8u2CYtjps",
  authDomain:"wow-hs-liste.firebaseapp.com",
  projectId:"wow-hs-liste",
  storageBucket:"wow-hs-liste.appspot.com",
  messagingSenderId:"180764359810",
  appId:"1:180764359810:web:03cef19546dcc32081889b"
};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

// Sounds
const soundUp=new Audio("https://freesound.org/data/previews/341/341695_6242730-lq.mp3");
const soundDown=new Audio("https://freesound.org/data/previews/341/341696_6242730-lq.mp3");

// Klassen & Rassen
const classes=["Krieger","Paladin","J√§ger","Schurke","Priester","Schamane","Magier","Hexenmeister","Druide"];
const races=["Mensch","Zwerg","Nachtelf","Gnom","Draenei","Ork","Troll","Tauren","Untoter","Blutelf"];

const classIcons={
Krieger:"https://wow.zamimg.com/images/wow/icons/large/class_warrior.jpg",
Paladin:"https://wow.zamimg.com/images/wow/icons/large/class_paladin.jpg",
J√§ger:"https://wow.zamimg.com/images/wow/icons/large/class_hunter.jpg",
Schurke:"https://wow.zamimg.com/images/wow/icons/large/class_rogue.jpg",
Priester:"https://wow.zamimg.com/images/wow/icons/large/class_priest.jpg",
Schamane:"https://wow.zamimg.com/images/wow/icons/large/class_shaman.jpg",
Magier:"https://wow.zamimg.com/images/wow/icons/large/class_mage.jpg",
Hexenmeister:"https://wow.zamimg.com/images/wow/icons/large/class_warlock.jpg",
Druide:"https://wow.zamimg.com/images/wow/icons/large/class_druid.jpg"
};

const raceIcons={
Mensch:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_human_male.jpg",
Zwerg:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_dwarf_male.jpg",
Nachtelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_nightelf_male.jpg",
Gnom:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_gnome_male.jpg",
Draenei:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_draenei_male.jpg",
Ork:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_orc_male.jpg",
Troll:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_troll_male.jpg",
Tauren:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_tauren_male.jpg",
Untoter:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_undead_male.jpg",
Blutelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_bloodelf_male.jpg"
};


// Fill selects with value/text
const fill=(id,arr)=>{const s=document.getElementById(id);arr.forEach(v=>{const o=document.createElement("option"); o.value=v;o.text=v;s.appendChild(o);});};
fill("race",races); fill("filterRace",races);
fill("wowClass",classes); fill("filterClass",classes);

// DOM
const email=document.getElementById("email"),
password=document.getElementById("password"),
loginPanel=document.getElementById("loginPanel"),
mainContent=document.getElementById("mainContent"),
list=document.getElementById("list"),
nameInput=document.getElementById("name"),
race=document.getElementById("race"),
wowClass=document.getElementById("wowClass"),
crimeInput=document.getElementById("crime"),
adminPanel=document.getElementById("adminPanel"),
pendingList=document.getElementById("pendingList");

// --- AUTH ---
loginBtn.onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
registerBtn.onclick=async()=>{
  const c=await createUserWithEmailAndPassword(auth,email.value,password.value);
  await setDoc(doc(db,"users",c.user.uid),{email:email.value,role:"pending"});
  alert("Registriert ‚Äì wartet auf Freigabe");
};
logoutBtn.onclick=()=>signOut(auth);

// --- Auth State ---
onAuthStateChanged(auth,async user=>{
  if(!user){loginPanel.style.display="block"; mainContent.style.display="none"; return;}
  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role==="pending"){alert("Noch nicht freigeschaltet"); signOut(auth); return;}
  loginPanel.style.display="none"; mainContent.style.display="block";
  if(snap.data().role==="admin"){adminPanel.style.display="block"; loadPending();} else {adminPanel.style.display="none";}
});

// --- Add Entry ---
addBtn.onclick=async()=>{
  if(!nameInput.value||!race.value||!wowClass.value||!crimeInput.value){alert("Bitte alle Felder ausf√ºllen"); return;}
  await addDoc(collection(db,"entries"),{
    uid: auth.currentUser.uid,
    name: nameInput.value,
    race: race.value,
    class: wowClass.value,
    crime: crimeInput.value,
    up:0, down:0,
    createdAt: serverTimestamp()
  });
  nameInput.value=""; race.value=""; wowClass.value=""; crimeInput.value="";
};

// --- Load Entries live ---
onSnapshot(collection(db,"entries"), snap=>{
  list.innerHTML="";
  snap.forEach(d=>{
    const e=d.data();
    const div=document.createElement("div");
    div.className="entry";
    const cIcon=classIcons[e.class]||"";
    const rIcon=raceIcons[e.race]||"";
    div.innerHTML=`
      <div class="icon" style="background-image:url(${rIcon})"></div>
      <div class="icon" style="background-image:url(${cIcon})"></div>
      <div><b>${e.name}</b><br>${e.race} / ${e.class}<br><small>${e.crime}</small></div>
      <div class="voteBox">
        <div class="voteRow">
          <span class="voteBtn" onclick="vote('${d.id}','up')">üëç ${e.up||0}</span>
          <span class="voteBtn" onclick="vote('${d.id}','down')">üëé ${e.down||0}</span>
        </div>
        <div class="editRow">
          <button onclick="editEntry('${d.id}','${e.name}','${e.race}','${e.class}','${e.crime}')">‚úèÔ∏è Bearbeiten</button>
          <button onclick="deleteEntry('${d.id}')">üóë L√∂schen</button>
        </div>
      </div>
    `;
    list.appendChild(div);
  });
});

// --- Voting ---
window.vote=async(entryId,type)=>{
  const user=auth.currentUser;
  if(!user){alert("Bitte einloggen"); return;}
  const voteRef=doc(db,"entries",entryId,"votes",user.uid);
  const entryRef=doc(db,"entries",entryId);
  const snap=await getDoc(voteRef);
  const entrySnap=await getDoc(entryRef);
  if(!entrySnap.exists()) return;
  let up=entrySnap.data().up||0;
  let down=entrySnap.data().down||0;
  if(!snap.exists()){await setDoc(voteRef,{type}); if(type==="up") up++; else down++;}
  else{const old=snap.data().type;if(old===type)return;if(old==="up") up=Math.max(up-1,0); else down=Math.max(down-1,0); if(type==="up") up++; else down++; await updateDoc(voteRef,{type});}
  await updateDoc(entryRef,{up,down});
  (type==="up"?soundUp:soundDown).play();
};

// --- Edit/Delete ---
window.editEntry=async(id,name,raceVal,classVal,crime)=>{
  const newName=prompt("Neuer Name:",name);
  const newRace=prompt("Neue Rasse:",raceVal);
  const newClass=prompt("Neue Klasse:",classVal);
  const newCrime=prompt("Neue Schandtat:",crime);
  if(newName&&newRace&&newClass&&newCrime) await updateDoc(doc(db,"entries",id),{name:newName,race:newRace,class:newClass,crime:newCrime});
};
window.deleteEntry=async(id)=>{if(confirm("Eintrag l√∂schen?")) await deleteDoc(doc(db,"entries",id));};

// --- Admin Pending ---
async function loadPending(){
  pendingList.innerHTML="";
  const snaps=await getDocs(collection(db,"users"));
  snaps.forEach(d=>{
    if(d.data().role==="pending"){
      pendingList.innerHTML += `${d.data().email} <button onclick="approveUser('${d.id}')">‚úî Freigeben</button><br>`;
    }
  });
}
window.approveUser=uid=>updateDoc(doc(db,"users",uid),{role:"user"}).then(loadPending);
</script>
</body>
</html>
