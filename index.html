<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WoW Classic ‚Äì Gildenliste</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Cinzel', serif; background: radial-gradient(circle at top, #2b1d0e, #0d0a06); color:#f5e6c8; }
.container { max-width:1200px; margin:40px auto; padding:30px; background:linear-gradient(180deg, rgba(20,14,7,.95), rgba(10,7,3,.98)); border:6px solid #c9a44c; border-radius:14px; }
h1 { text-align:center; color:#ffd36a; margin-bottom:20px; }
input, select, button { padding:10px; background:#120c05; border:2px solid #9c7c3f; color:#f5e6c8; border-radius:6px; font-family:inherit; }
button { cursor:pointer; background:linear-gradient(to bottom,#e0b75a,#8a6b2f); color:#1b1206; font-weight:bold; }
#loginPanel { max-width:400px; margin:20px auto; padding:20px; background:#1a1208; border-radius:12px; }
.form { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px; }
.form-full { display:flex; width:100%; }
#crime { flex:1; min-width:100%; }
.form-buttons { display:flex; justify-content:center; gap:12px; margin-top:10px; }
.list { margin-top:30px; }
.entry { display:grid; grid-template-columns:44px 44px 2fr 50px 50px; gap:12px; align-items:flex-start; padding:12px; background:linear-gradient(180deg,#1a1208,#0d0904); border:2px solid #8c6a32; border-left:8px solid; border-radius:8px; }
.icon { width:40px; height:40px; background-size:cover; background-position:center; border:2px solid #c9a44c; border-radius:4px; }
.class-name { font-weight:bold; text-shadow:0 0 6px #000; }
#adminPanel { margin-top:20px; background:#1a1208; padding:10px; border-radius:8px; border:2px solid #8c6a32; display:none; }
.adminUser { display:flex; justify-content:space-between; margin-bottom:6px; }
.adminUser button { padding:2px 6px; font-size:0.8em; }
</style>
</head>
<body>
<div class="container">
<h1>WoW Classic ‚Äì Gildenliste</h1>

<!-- LOGIN -->
<div id="loginPanel">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Passwort">
    <button id="registerBtn">Registrieren</button>
    <button id="loginBtn">Login</button>
</div>

<!-- MAIN CONTENT -->
<div id="mainContent" style="display:none;">
    <!-- Formular -->
    <div class="form">
        <input id="name" placeholder="Name">
        <select id="race">
            <option value="">Rasse</option>
            <option>Mensch</option><option>Zwerg</option><option>Nachtelf</option>
            <option>Ork</option><option>Untoter</option><option>Tauren</option>
        </select>
        <select id="wowClass">
            <option value="">Klasse</option>
            <option>Krieger</option><option>Magier</option><option>Priester</option>
            <option>Schurke</option><option>J√§ger</option><option>Hexenmeister</option><option>Druide</option>
        </select>
    </div>
    <div class="form-full">
        <input id="crime" placeholder="Schandtat">
    </div>
    <div class="form-buttons">
        <button id="addBtn">Hinzuf√ºgen</button>
        <button id="logoutBtn">Logout</button>
    </div>

    <!-- Eintr√§ge -->
    <div id="list" class="list"></div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel">
        <h3>Pending-User Freischalten</h3>
        <div id="pendingList"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* CONFIG */
const firebaseConfig = {
  apiKey:"AIzaSyBOko8Wg-jCvz7aRPleNcbJCm8u2CYtjps",
  authDomain:"wow-hs-liste.firebaseapp.com",
  projectId:"wow-hs-liste",
  storageBucket:"wow-hs-liste.firebasestorage.app",
  messagingSenderId:"180764359810",
  appId:"1:180764359810:web:03cef19546dcc32081889b"
};

/* INIT */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* KLASSEN + ICONS */
const initialClassData = {
  Krieger:{ color:"#C79C6E", role:"Tank", icon:"https://wow.zamimg.com/images/wow/icons/large/class_warrior.jpg" },
  Magier:{ color:"#69CCF0", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_mage.jpg" },
  Priester:{ color:"#FFFFFF", role:"Heal", icon:"https://wow.zamimg.com/images/wow/icons/large/class_priest.jpg" },
  Schurke:{ color:"#FFF569", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_rogue.jpg" },
  J√§ger:{ color:"#ABD473", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_hunter.jpg" },
  Hexenmeister:{ color:"#9482C9", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_warlock.jpg" },
  Druide:{ color:"#FF7D0A", role:"Heal", icon:"https://wow.zamimg.com/images/wow/icons/large/class_druid.jpg" }
};

const raceIcons={Mensch:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_human_male.jpg",
Zwerg:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_dwarf_male.jpg",
Nachtelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_nightelf_male.jpg",
Ork:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_orc_male.jpg",
Untoter:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_undead_male.jpg",
Tauren:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_tauren_male.jpg"};

// DOM
const email=document.getElementById("email");
const password=document.getElementById("password");
const loginPanel=document.getElementById("loginPanel");
const mainContent=document.getElementById("mainContent");
const list=document.getElementById("list");
const nameInput=document.getElementById("name");
const race=document.getElementById("race");
const wowClass=document.getElementById("wowClass");
const crimeInput=document.getElementById("crime");
const adminPanel=document.getElementById("adminPanel");
const pendingList=document.getElementById("pendingList");

// REGISTER / LOGIN
document.getElementById("registerBtn").onclick=async()=>{
    const cred = await createUserWithEmailAndPassword(auth,email.value,password.value);
    await doc(db,"users",cred.user.uid).set({email:email.value, role:"pending"});
    alert("Registriert ‚Äì Admin muss freischalten");
    signOut(auth);
};

document.getElementById("loginBtn").onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
document.getElementById("logoutBtn").onclick=()=>signOut(auth);

// AUTH STATE
onAuthStateChanged(auth, async user=>{
    if(!user){ loginPanel.style.display="block"; mainContent.style.display="none"; return; }

    const snap = await doc(db,"users",user.uid).get();
    if(!snap.exists || snap.data().role==="pending"){ alert("Noch nicht freigeschaltet"); signOut(auth); return; }

    loginPanel.style.display="none"; mainContent.style.display="block";

    const role = snap.data().role;
    if(role==="admin") { adminPanel.style.display="block"; loadPending(); } else { adminPanel.style.display="none"; }

    loadEntries();
});

// ADD ENTRY
document.getElementById("addBtn").onclick=async()=>{
    const user = auth.currentUser;
    if(!user){ alert("Nicht eingeloggt"); return; }
    if(!nameInput.value || !race.value || !wowClass.value || !crimeInput.value){ alert("Alle Felder ausf√ºllen"); return; }

    await addDoc(collection(db,"entries"),{
        uid:user.uid,
        name:nameInput.value,
        race:race.value,
        class:wowClass.value,
        crime:crimeInput.value,
        role:initialClassData[wowClass.value].role,
        createdAt:serverTimestamp()
    });

    nameInput.value=""; race.value=""; wowClass.value=""; crimeInput.value="";
};

// LOAD ENTRIES
function loadEntries(){
    const q = query(collection(db,"entries"), orderBy("createdAt"));
    onSnapshot(q, snap=>{
        list.innerHTML="";
        snap.forEach(doc=>{
            const e = doc.data();
            const div = document.createElement("div");
            div.className="entry";
            div.style.borderLeftColor = initialClassData[e.class].color;

            div.innerHTML=`
            <div class="icon" style="background-image:url(${raceIcons[e.race]})"></div>
            <div class="icon" style="background-image:url(${initialClassData[e.class].icon})"></div>
            <div>
              <strong>${e.name}</strong><br>
              <small>${e.race} / ${e.class}</small><br>
              <small>Schandtat: ${e.crime}</small>
            </div>
            <button onclick="editEntry('${doc.id}','${e.name}','${e.race}','${e.class}','${e.crime}')">‚úèÔ∏è</button>
            <button onclick="deleteEntry('${doc.id}')">üóë</button>
            `;
            list.appendChild(div);
        });
    });
}

// EDIT ENTRY
window.editEntry=async(id,name,raceVal,classVal,crime)=>{
    const newName = prompt("Neuer Name:",name);
    const newRace = prompt("Neue Rasse:",raceVal);
    const newClass = prompt("Neue Klasse:",classVal);
    const newCrime = prompt("Neue Schandtat:",crime);

    if(newName && newRace && newClass && newCrime){
        await updateDoc(doc(db,"entries",id),{
            name:newName,
            race:newRace,
            class:newClass,
            crime:newCrime,
            role: initialClassData[newClass].role
        });
    }
};

// DELETE ENTRY
window.deleteEntry=async(id)=>{ if(confirm("Eintrag l√∂schen?")) await deleteDoc(doc(db,"entries",id)); }

// ADMIN PANEL
async function loadPending(){
    pendingList.innerHTML="";
    const q = await getDocs(collection(db,"users"));
    q.forEach(docu=>{
        const u = docu.data();
        if(u.role==="pending"){
            const div=document.createElement("div");
            div.className="adminUser";
            div.innerHTML=`${u.email} <button onclick="approveUser('${docu.id}')">Freischalten</button>`;
            pendingList.appendChild(div);
        }
    });
}
window.approveUser=async(uid)=>{ await updateDoc(doc(db,"users",uid),{role:"user"}); loadPending(); }
</script>
</body>
</html>
