<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WoW Classic / TBC ‚Äì Schandtatenliste</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<style>
body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f5e6c8;
  background:url('https://i.imgur.com/7LzGxKb.jpg') no-repeat center center fixed;
  background-size:cover;
}
.container{
  max-width:1200px;
  margin:20px auto;
  padding:25px;
  background:linear-gradient(145deg, rgba(15,10,5,0.95), rgba(25,18,10,0.9));
  border:4px solid #c9a44c;
  border-image:linear-gradient(45deg, #c9a44c, #ffd36a, #c9a44c) 1;
  border-radius:18px;
  box-shadow:0 0 40px rgba(201,164,76,0.4), inset 0 0 20px rgba(0,0,0,0.8);
  position:relative;
}
.container::before{
  content:'';
  position:absolute;
  top:-10px; left:-10px; right:-10px; bottom:-10px;
  background:linear-gradient(45deg, transparent 49%, rgba(201,164,76,0.1) 50%, transparent 51%);
  border-radius:25px;
  z-index:-1;
}
h1{
  text-align:center;
  color:#ffd36a;
  text-shadow:0 0 15px rgba(255,211,106,0.8), 2px 2px 4px rgba(0,0,0,0.9);
  font-size:2.2em;
  margin:0 0 25px 0;
  letter-spacing:3px;
}
input,select{
  padding:10px 14px;
  background:linear-gradient(145deg, #2a1f12, #1a1208);
  border:2px solid #8c6a32;
  color:#f5e6c8;
  border-radius:8px;
  font-family:inherit;
  font-size:13px;
  box-shadow:inset 0 2px 4px rgba(0,0,0,0.6);
  text-shadow:1px 1px 2px rgba(0,0,0,0.8);
}
input:focus,select:focus{
  outline:none;
  border-color:#ffd36a;
  box-shadow:0 0 12px rgba(255,211,106,0.5);
}
button{
  cursor:pointer;
  font-family:'Cinzel',serif;
  font-weight:700;
  position:relative;
  overflow:hidden;
  transition:all 0.3s ease;
  text-transform:uppercase;
  letter-spacing:1px;
}
button::before{
  content:'';
  position:absolute;
  top:0; left:-100%;
  width:100%; height:100%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition:left 0.5s;
}
button:hover::before{left:100%;}
button:hover{transform:translateY(-2px);}
.btn-wow{
  background:linear-gradient(145deg, #d4af37, #b8942f, #8c6a32);
  color:#1a0f06;
  border:2px solid #ffd36a;
  border-radius:10px;
  padding:8px 16px;
  font-size:12px;
  box-shadow:0 4px 12px rgba(212,175,55,0.4), inset 0 1px 0 rgba(255,255,255,0.3);
  text-shadow:0 1px 1px rgba(255,255,255,0.5);
}
.btn-wow:hover{
  background:linear-gradient(145deg, #ffd36a, #e0b75a, #c9a44c);
  box-shadow:0 6px 18px rgba(212,175,55,0.6);
  border-color:#ffeb8a;
}
.btn-wow:active{
  transform:translateY(0);
  box-shadow:0 2px 8px rgba(212,175,55,0.3);
}
.btn-small{
  background:linear-gradient(145deg, #6b4e31, #4a3620);
  color:#f5e6c8;
  border:2px solid #8c6a32;
  border-radius:6px;
  padding:4px 10px;
  font-size:11px;
  box-shadow:0 3px 8px rgba(107,78,49,0.4);
  text-shadow:0 1px 2px rgba(0,0,0,0.8);
}
.btn-small:hover{
  background:linear-gradient(145deg, #8c6a32, #6b4e31);
  box-shadow:0 5px 12px rgba(107,78,49,0.6);
  border-color:#c9a44c;
}
.btn-action{
  width:28px; height:28px;
  padding:0;
  border-radius:6px;
  font-size:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  background:linear-gradient(145deg, #c79c6e, #a87d4e);
  border:2px solid #d4af37;
  color:#2a1f12;
  box-shadow:0 3px 8px rgba(199,156,110,0.4);
}
.btn-action:hover{
  background:linear-gradient(145deg, #d4af37, #c79c6e);
  box-shadow:0 5px 12px rgba(199,156,110,0.6);
}
#loginPanel{
  max-width:450px;
  margin:0 auto 30px;
  padding:30px;
  background:linear-gradient(145deg, #1f150d, #120a06);
  border:3px solid #8c6a32;
  border-radius:16px;
  box-shadow:0 8px 25px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
  text-align:center;
}
.form,.filters{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-bottom:15px;
  padding:15px;
  background:rgba(26,18,8,0.4);
  border-radius:10px;
  border:1px solid rgba(140,106,50,0.3);
}
.form-full{width:100%;}
#crime{flex:1;min-width:100%;}
.form-buttons{
  display:flex;
  justify-content:center;
  gap:15px;
  margin-top:15px;
}
#list{
  margin-top:25px;
  display:block;
}
.entry{
  display:flex;
  flex-direction:column;
  width:100%;
  background:linear-gradient(145deg, #2a1f12, #1a1208, #120a06);
  border:3px solid #8c6a32;
  border-left:10px solid;
  border-image:linear-gradient(to bottom, transparent 20%, currentColor 50%, transparent 80%) 1;
  border-radius:16px;
  padding:18px;
  box-shadow:0 8px 25px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.05);
  position:relative;
  transition:all 0.3s ease;
  margin-bottom:18px;
}
.entry::before{
  content:'';
  position:absolute;
  top:0; left:0; right:0;
  height:4px;
  background:linear-gradient(90deg, transparent, #ffd36a, transparent);
  border-radius:16px 16px 0 0;
}
.entry:hover{
  transform:translateY(-6px);
  box-shadow:0 15px 35px rgba(201,164,76,0.3), inset 0 1px 0 rgba(255,255,255,0.08);
}
.entry-top{
  display:flex;
  align-items:flex-start;
  gap:15px;
}
.icon-row{
  display:flex;
  gap:6px;
}
.icon{
  width:36px;
  height:36px;
  background-size:cover;
  background-position:center;
  border:3px solid #c9a44c;
  border-radius:8px;
  box-shadow:0 3px 10px rgba(0,0,0,0.6);
  position:relative;
}
.icon::after{
  content:'';
  position:absolute;
  bottom:-3px; right:-3px;
  width:12px; height:12px;
  background:#ffd36a;
  border-radius:50%;
  box-shadow:0 2px 5px rgba(0,0,0,0.4);
}
.entry-body{
  flex:1;
  color:#f5e6c8;
  margin-left:12px;
}
.entry-name{
  font-weight:700;
  font-size:16px;
  color:#ffd36a;
  text-shadow:1px 1px 2px rgba(0,0,0,0.8);
  margin-bottom:4px;
}
.entry-info{
  font-size:12px;
  color:#d4af37;
  margin-bottom:8px;
  text-shadow:1px 1px 2px rgba(0,0,0,0.8);
}
.entry-crime{
  font-size:13px;
  line-height:1.4;
  color:#f0e6d2;
  padding:8px 0;
  border-left:3px solid rgba(140,106,50,0.5);
  padding-left:12px;
}
.voteBox{
  display:flex;
  align-items:center;
  gap:6px;
  position:absolute;
  top:12px;
  right:15px;
  background:rgba(26,18,8,0.9);
  padding:8px 12px;
  border-radius:12px;
  border:2px solid #6b4e31;
  box-shadow:0 4px 12px rgba(0,0,0,0.6);
}
.voteBtn{
  font-size:18px;
  cursor:pointer;
  opacity:0.7;
  transition:all 0.2s ease;
  padding:4px;
  border-radius:6px;
}
.voteBtn:hover{
  transform:scale(1.2);
  opacity:1;
  background:rgba(255,255,255,0.1);
}
.voteCount{
  min-width:22px;
  text-align:center;
  font-size:13px;
  font-weight:600;
  color:#ffd36a;
}
.entry-actions{
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:12px;
  padding-top:12px;
  border-top:2px solid rgba(140,106,50,0.4);
}
#adminPanel{
  margin-top:25px;
  background:linear-gradient(145deg, #2a1f12, #1a1208);
  padding:18px;
  border-radius:12px;
  border:3px solid #8c6a32;
  box-shadow:0 8px 25px rgba(0,0,0,0.8);
  display:none;
}
.adminUser{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  padding:12px;
  background:rgba(41,31,18,0.6);
  border-radius:10px;
  border-left:5px solid #c9a44c;
}
#updateHistory{
  margin-top:25px;
  background:linear-gradient(145deg, #1f150d, #120a06);
  padding:18px;
  border-radius:12px;
  border:3px solid #6b4e31;
  max-height:220px;
  overflow-y:auto;
  font-size:12px;
  box-shadow:0 8px 25px rgba(0,0,0,0.8);
}
#updateHistory div{
  padding:6px 0;
  border-bottom:1px solid rgba(140,106,50,0.2);
}
#updateHistory strong{
  color:#ffd36a;
}
</style>
</head>
<body>
<div class="container">
  <h1>WoW Classic / TBC ‚Äì Schandtatenliste</h1>

  <div id="loginPanel">
    <input type="email" id="email" placeholder="Email-Adresse"><br><br>
    <input type="password" id="password" placeholder="Passwort"><br><br>
    <button id="registerBtn" class="btn-wow">Registrieren</button>
    <button id="loginBtn" class="btn-wow">Einloggen</button>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="filters">
      <input id="search" placeholder="Suche nach Namen oder Schandtaten...">
      <select id="filterRace">
        <option value="">Alle Rassen</option>
        <option>Mensch</option><option>Zwerg</option><option>Nachtelf</option>
        <option>Gnom</option><option>Draenei</option>
        <option>Ork</option><option>Troll</option><option>Tauren</option>
        <option>Untoter</option><option>Blutelf</option>
      </select>
      <select id="filterClass">
        <option value="">Alle Klassen</option>
        <option>Krieger</option><option>Paladin</option><option>J√§ger</option>
        <option>Schurke</option><option>Priester</option>
        <option>Schamane</option><option>Magier</option>
        <option>Hexenmeister</option><option>Druide</option>
      </select>
    </div>

    <div class="form">
      <input id="name" placeholder="Name">
      <select id="race">
        <option value="">Rasse w√§hlen</option>
        <option>Mensch</option><option>Zwerg</option><option>Nachtelf</option>
        <option>Gnom</option><option>Draenei</option>
        <option>Ork</option><option>Troll</option><option>Tauren</option>
        <option>Untoter</option><option>Blutelf</option>
      </select>
      <select id="wowClass">
        <option value="">Klasse w√§hlen</option>
        <option>Krieger</option><option>Paladin</option><option>J√§ger</option>
        <option>Schurke</option><option>Priester</option>
        <option>Schamane</option><option>Magier</option>
        <option>Hexenmeister</option><option>Druide</option>
      </select>
    </div>
    <div class="form-full">
      <input id="crime" placeholder="Die Schandtat beschreiben...">
    </div>
    <div class="form-buttons">
      <button id="addBtn" class="btn-wow">Schandtat melden</button>
      <button id="logoutBtn" class="btn-wow">Abmelden</button>
    </div>

    <div id="list"></div>

    <div id="adminPanel">
      <h3 style="color:#ffd36a;margin:0 0 15px 0;">‚õ® Pending-User freischalten</h3>
      <div id="pendingList"></div>
    </div>

    <div id="updateHistory">
      <strong>üìú Kampagnen-Protokoll:</strong>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, onSnapshot,
  serverTimestamp, doc, getDoc, getDocs, updateDoc, deleteDoc,
  setDoc, increment
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBOko8Wg-jCvz7aRPleNcbJCm8u2CYtjps",
  authDomain:"wow-hs-liste.firebaseapp.com",
  projectId:"wow-hs-liste",
  storageBucket:"wow-hs-liste.appspot.com",
  messagingSenderId:"180764359810",
  appId:"1:180764359810:web:03cef19546dcc32081889b"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const initialClassData = {
  Krieger:{color:"#C79C6E",icon:"https://wow.zamimg.com/images/wow/icons/large/class_warrior.jpg"},
  Magier:{color:"#69CCF0",icon:"https://wow.zamimg.com/images/wow/icons/large/class_mage.jpg"},
  Priester:{color:"#FFFFFF",icon:"https://wow.zamimg.com/images/wow/icons/large/class_priest.jpg"},
  Schurke:{color:"#FFF569",icon:"https://wow.zamimg.com/images/wow/icons/large/class_rogue.jpg"},
  J√§ger:{color:"#ABD473",icon:"https://wow.zamimg.com/images/wow/icons/large/class_hunter.jpg"},
  Hexenmeister:{color:"#9482C9",icon:"https://wow.zamimg.com/images/wow/icons/large/class_warlock.jpg"},
  Druide:{color:"#FF7D0A",icon:"https://wow.zamimg.com/images/wow/icons/large/class_druid.jpg"},
  Paladin:{color:"#F58CBA",icon:"https://wow.zamimg.com/images/wow/icons/large/class_paladin.jpg"},
  Schamane:{color:"#0070DE",icon:"https://wow.zamimg.com/images/wow/icons/large/class_shaman.jpg"}
};
const raceIcons = {
  Mensch:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_human_male.jpg",
  Zwerg:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_dwarf_male.jpg",
  Nachtelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_nightelf_male.jpg",
  Gnom:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_gnome_male.jpg",
  Draenei:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_draenei_male.jpg",
  Ork:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_orc_male.jpg",
  Troll:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_troll_male.jpg",
  Tauren:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_tauren_male.jpg",
  Untoter:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_undead_male.jpg",
  Blutelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_bloodelf_male.jpg"
};

const email        = document.getElementById("email");
const password     = document.getElementById("password");
const loginPanel   = document.getElementById("loginPanel");
const mainContent  = document.getElementById("mainContent");
const list         = document.getElementById("list");
const nameInput    = document.getElementById("name");
const race         = document.getElementById("race");
const wowClass     = document.getElementById("wowClass");
const crimeInput   = document.getElementById("crime");
const adminPanel   = document.getElementById("adminPanel");
const pendingList  = document.getElementById("pendingList");
const updateHistory= document.getElementById("updateHistory");
const searchInput  = document.getElementById("search");
const filterRace   = document.getElementById("filterRace");
const filterClass  = document.getElementById("filterClass");

let entries = [];

document.getElementById("registerBtn").onclick = async () => {
  try{
    const cred = await createUserWithEmailAndPassword(auth,email.value,password.value);
    await setDoc(doc(db,"users",cred.user.uid),{email:email.value,role:"pending"});
    alert("Registriert ‚Äì Der Gro√üverwalter muss dich freischalten!");
    signOut(auth);
  }catch(e){
    alert("Fehler: "+e.message);
  }
};
document.getElementById("loginBtn").onclick  = () =>
  signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
document.getElementById("logoutBtn").onclick = () => signOut(auth);

onAuthStateChanged(auth, async user => {
  if(!user){
    loginPanel.style.display="block";
    mainContent.style.display="none";
    return;
  }
  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role==="pending"){
    alert("Noch nicht vom Gro√üverwalter freigeschaltet!");
    signOut(auth);
    return;
  }
  loginPanel.style.display="none";
  mainContent.style.display="block";
  if(snap.data().role==="admin"){
    adminPanel.style.display="block";
    loadPending();
  }else adminPanel.style.display="none";
  loadEntries();
});

document.getElementById("addBtn").onclick = async () => {
  const user = auth.currentUser;
  if(!user || !nameInput.value || !race.value || !wowClass.value || !crimeInput.value){
    alert("Alle Felder ausf√ºllen, Schandtat!");
    return;
  }
  await addDoc(collection(db,"entries"),{
    uid:user.uid,
    name:nameInput.value,
    race:race.value,
    class:wowClass.value,
    crime:crimeInput.value,
    role:initialClassData[wowClass.value]?.role || "",
    upvotes:0,
    downvotes:0,
    createdAt:serverTimestamp()
  });
  appendUpdate(`Schandtat gemeldet: ${nameInput.value}`);
  nameInput.value=""; race.value=""; wowClass.value=""; crimeInput.value="";
};

function appendUpdate(text){
  const p=document.createElement("div");
  p.innerText=`${new Date().toLocaleString()}: ${text}`;
  updateHistory.appendChild(p);
  updateHistory.scrollTop=updateHistory.scrollHeight;
}

function loadEntries(){
  const q=query(collection(db,"entries"),orderBy("createdAt"));
  onSnapshot(q,snap=>{
    entries = snap.docs.map(d => ({id:d.id, ...d.data()}));
    renderEntries();
  });
}

function renderEntries(){
  list.innerHTML="";
  const term = (searchInput.value || "").toLowerCase();
  const fr   = filterRace.value;
  const fc   = filterClass.value;

  entries
    .filter(e =>
      (!fr || e.race===fr) &&
      (!fc || e.class===fc) &&
      (!term ||
        e.name.toLowerCase().includes(term) ||
        e.crime.toLowerCase().includes(term))
    )
    .forEach(data => {
      const div=document.createElement("div");
      div.className="entry";
      div.id="entry-"+data.id;
      div.style.borderLeftColor = initialClassData[data.class]?.color || "#8c6a32";

      div.innerHTML = `
        <div class="entry-top">
          <div class="icon-row">
            <div class="icon" style="background-image:url('${raceIcons[data.race] || ''}')"></div>
            <div class="icon" style="background-image:url('${initialClassData[data.class]?.icon || ''}')"></div>
          </div>
          <div class="entry-body">
            <div class="entry-name">${data.name}</div>
            <div class="entry-info">${data.race} / ${data.class}</div>
            <div class="entry-crime">Schandtat: ${data.crime}</div>
          </div>
          <div class="voteBox">
            <span class="voteBtn" id="up-${data.id}">üëç</span>
            <span class="voteCount" id="upc-${data.id}">${data.upvotes}</span>
            <span class="voteBtn" id="down-${data.id}">üëé</span>
            <span class="voteCount" id="downc-${data.id}">${data.downvotes}</span>
          </div>
        </div>
        <div class="entry-actions">
          <button id="edit-${data.id}" class="btn-action" title="Bearbeiten">‚úèÔ∏è</button>
          <button id="del-${data.id}" class="btn-action" title="L√∂schen">üóë</button>
        </div>
      `;

      list.appendChild(div);

      document.getElementById("up-"+data.id).onclick   = () => vote(data.id,"up");
      document.getElementById("down-"+data.id).onclick = () => vote(data.id,"down");
      document.getElementById("edit-"+data.id).onclick =
        () => editEntry(data.id,data.name,data.race,data.class,data.crime);
      document.getElementById("del-"+data.id).onclick  =
        () => deleteEntry(data.id);
    });
}

searchInput.addEventListener("input",renderEntries);
filterRace.addEventListener("change",renderEntries);
filterClass.addEventListener("change",renderEntries);

async function vote(id,type){
  const user=auth.currentUser;
  if(!user){alert("Tritt der Allianz/Horde bei! (Login)");return;}
  const voteRef = doc(db,"entries",id,"votes",user.uid);
  const entryRef= doc(db,"entries",id);
  const snap    = await getDoc(voteRef);

  if(!snap.exists()){
    await setDoc(voteRef,{type});
    await updateDoc(entryRef,{
      [type==='up'?'upvotes':'downvotes']:increment(1)
    });
  }else{
    const old=snap.data().type;
    if(old===type)return;
    await updateDoc(voteRef,{type});
    await updateDoc(entryRef,{
      [old==='up'?'upvotes':'downvotes']:increment(-1),
      [type==='up'?'upvotes':'downvotes']:increment(1)
    });
  }
}

async function editEntry(id,name,raceVal,classVal,crime){
  const newName  = prompt("Neuer Name:",name);
  const newRace  = prompt("Neue Rasse:",raceVal);
  const newClass = prompt("Neue Klasse:",classVal);
  const newCrime = prompt("Neue Schandtat:",crime);
  if(newName && newRace && newClass && newCrime){
    await updateDoc(doc(db,"entries",id),{
      name:newName,
      race:newRace,
      class:newClass,
      crime:newCrime,
      role:initialClassData[newClass]?.role || ""
    });
    appendUpdate(`Schandtat ge√§ndert: ${newName}`);
  }
}
async function deleteEntry(id){
  if(confirm("Diese Schandtat aus dem Archiv tilgen?")){
    await deleteDoc(doc(db,"entries",id));
    appendUpdate(`Schandtat gel√∂scht: ${id}`);
  }
}

async function loadPending(){
  pendingList.innerHTML="";
  const snaps=await getDocs(collection(db,"users"));
  snaps.forEach(d=>{
    const u=d.data();
    if(u.role==="pending"){
      const div=document.createElement("div");
      div.className="adminUser";
      div.innerHTML=`${u.email} <button class="btn-small">Freischalten</button>`;
      pendingList.appendChild(div);
      div.querySelector("button").onclick = () => approveUser(d.id);
    }
  });
}
async function approveUser(uid){
  await updateDoc(doc(db,"users",uid),{role:"user"});
  loadPending();
  appendUpdate(`K√§mpfer freigeschaltet: ${uid}`);
}
</script>
</body>
</html>
