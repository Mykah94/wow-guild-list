<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WoW Classic â€“ Gildenliste</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Cinzel', serif; background: radial-gradient(circle at top, #2b1d0e, #0d0a06); color:#f5e6c8; }
.container { max-width:1200px; margin:40px auto; padding:30px; background:linear-gradient(180deg, rgba(20,14,7,.95), rgba(10,7,3,.98)); border:6px solid #c9a44c; border-radius:14px; }
h1 { text-align:center; color:#ffd36a; margin-bottom:20px; }
input, select, button { padding:10px; background:#120c05; border:2px solid #9c7c3f; color:#f5e6c8; border-radius:6px; font-family:inherit; }
button { cursor:pointer; background:linear-gradient(to bottom,#e0b75a,#8a6b2f); color:#1b1206; font-weight:bold; }
#loginPanel { max-width:400px; margin:20px auto; padding:20px; background:#1a1208; border-radius:12px; }
.form { display:grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap:12px; margin-bottom:20px; }
.list { margin-top:30px; }
.entry { display:grid; grid-template-columns:44px 44px 2fr 1fr 80px 1.2fr 50px; gap:12px; align-items:center; padding:12px; background:linear-gradient(180deg,#1a1208,#0d0904); border:2px solid #8c6a32; border-left:8px solid; border-radius:8px; }
.icon { width:40px; height:40px; background-size:cover; background-position:center; border:2px solid #c9a44c; border-radius:4px; }
.class-name { font-weight:bold; text-shadow:0 0 6px #000; }
#adminPanel { margin-top:20px; background:#1a1208; padding:10px; border-radius:8px; border:2px solid #8c6a32; display:none; }
.adminUser { display:flex; justify-content:space-between; margin-bottom:6px; }
.adminUser button { padding:2px 6px; font-size:0.8em; }
</style>
</head>
<body>
<div class="container">
<h1>WoW Classic â€“ Gildenliste</h1>

<!-- LOGIN -->
<div id="loginPanel">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Passwort">
    <button id="registerBtn">Registrieren</button>
    <button id="loginBtn">Login</button>
</div>

<!-- MAIN CONTENT -->
<div id="mainContent" style="display:none;">
<div class="form">
    <input id="name" placeholder="Name">
    <input id="guild" placeholder="Gilde">
    <input id="level" type="number" placeholder="Level">
    <select id="race">
        <option value="">Rasse</option>
        <option>Mensch</option><option>Zwerg</option><option>Nachtelf</option>
        <option>Ork</option><option>Untoter</option><option>Tauren</option>
    </select>
    <select id="wowClass">
        <option value="">Klasse</option>
        <option>Krieger</option><option>Magier</option><option>Priester</option>
        <option>Schurke</option><option>JÃ¤ger</option><option>Hexenmeister</option><option>Druide</option>
    </select>
    <button id="addBtn">HinzufÃ¼gen</button>
    <button id="logoutBtn">Logout</button>
</div>

<div id="list" class="list"></div>

<!-- ADMIN PANEL -->
<div id="adminPanel">
    <h3>Pending-User Freischalten</h3>
    <div id="pendingList"></div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* CONFIG */
const firebaseConfig = {
  apiKey:"AIzaSyBOko8Wg-jCvz7aRPleNcbJCm8u2CYtjps",
  authDomain:"wow-hs-liste.firebaseapp.com",
  projectId:"wow-hs-liste",
  storageBucket:"wow-hs-liste.firebasestorage.app",
  messagingSenderId:"180764359810",
  appId:"1:180764359810:web:03cef19546dcc32081889b"
};

/* INIT */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* HARD-CODED KLASSEN */
const initialClassData = {
  Krieger:{ color:"#C79C6E", role:"Tank", icon:"https://wow.zamimg.com/images/wow/icons/large/class_warrior.jpg" },
  Magier:{ color:"#69CCF0", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_mage.jpg" },
  Priester:{ color:"#FFFFFF", role:"Heal", icon:"https://wow.zamimg.com/images/wow/icons/large/class_priest.jpg" },
  Schurke:{ color:"#FFF569", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_rogue.jpg" },
  JÃ¤ger:{ color:"#ABD473", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_hunter.jpg" },
  Hexenmeister:{ color:"#9482C9", role:"DPS", icon:"https://wow.zamimg.com/images/wow/icons/large/class_warlock.jpg" },
  Druide:{ color:"#FF7D0A", role:"Heal", icon:"https://wow.zamimg.com/images/wow/icons/large/class_druid.jpg" }
};

const raceIcons={Mensch:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_human_male.jpg",
Zwerg:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_dwarf_male.jpg",
Nachtelf:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_nightelf_male.jpg",
Ork:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_orc_male.jpg",
Untoter:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_undead_male.jpg",
Tauren:"https://wow.zamimg.com/images/wow/icons/large/achievement_character_tauren_male.jpg"};

const email=document.getElementById("email");
const password=document.getElementById("password");
const loginPanel=document.getElementById("loginPanel");
const mainContent=document.getElementById("mainContent");
const adminPanel=document.getElementById("adminPanel");
const pendingList=document.getElementById("pendingList");
const list=document.getElementById("list");
const nameInput=document.getElementById("name");
const guild=document.getElementById("guild");
const level=document.getElementById("level");
const race=document.getElementById("race");
const wowClass=document.getElementById("wowClass");

/* REGISTER */
document.getElementById("registerBtn").onclick=async()=>{
    const cred=await createUserWithEmailAndPassword(auth,email.value,password.value);
    await setDoc(doc(db,"users",cred.user.uid),{role:"pending",email:email.value});
    alert("Registriert â€“ Admin muss freischalten");
    signOut(auth);
};

/* LOGIN */
document.getElementById("loginBtn").onclick=()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
document.getElementById("logoutBtn").onclick=()=>signOut(auth);

/* EINMALIG KLASSEN INIT & AUTH STATE */
async function ensureClasses() {
    const colSnap = await getDocs(collection(db,"classes"));
    if(colSnap.empty){
        for(const [name,data] of Object.entries(initialClassData)){
            await setDoc(doc(db,"classes",name), data);
        }
        console.log("Alle Klassen einmalig erstellt");
    }
}

onAuthStateChanged(auth, async user=>{
    if(!user){ loginPanel.style.display="block"; mainContent.style.display="none"; return; }
    const snap = await getDoc(doc(db,"users",user.uid));
    if(!snap.exists() || snap.data().role==="pending"){ alert("Account noch nicht freigeschaltet"); signOut(auth); return; }

    loginPanel.style.display="none";
    mainContent.style.display="block";

    if(snap.data().role==="admin") {
        adminPanel.style.display="block";
        await ensureClasses();
        loadPending();
    } else { adminPanel.style.display="none"; }

    loadEntries();
});

/* ADD ENTRY */
document.getElementById("addBtn").onclick=async()=>{
    try {
        const snap = await getDoc(doc(db,"users",auth.currentUser.uid));
        const role = snap.data().role;
        if(role !== "user" && role !== "admin"){ alert("Du bist noch nicht freigeschaltet!"); return; }

        const selectedClass = wowClass.value;
        if(!nameInput.value || !race.value || !selectedClass){ alert("Name, Rasse und Klasse sind Pflicht"); return; }
        const classInfo = initialClassData[selectedClass];
        if(!classInfo){ alert("UngÃ¼ltige Klasse"); return; }

        await addDoc(collection(db,"entries"),{
            name: nameInput.value,
            guild: guild.value||"",
            level: level.value||"?",
            race: race.value,
            class: selectedClass,
            role: classInfo.role,
            createdAt: serverTimestamp()
        });

        // Reset Formular
        nameInput.value=""; guild.value=""; level.value=""; race.value=""; wowClass.value="";
        alert("Eintrag erfolgreich hinzugefÃ¼gt!");
    } catch(e){ alert("Fehler beim Speichern: "+e.message); }
};

/* LOAD ENTRIES */
function loadEntries(){
    const q=query(collection(db,"entries"),orderBy("createdAt"));
    onSnapshot(q,snap=>{
        list.innerHTML="";
        snap.forEach(doc=>{
            const e = doc.data();
            const div = document.createElement("div");
            div.className = "entry";
            div.style.borderLeftColor = initialClassData[e.class].color;
            div.innerHTML = `
            <div class="icon" style="background-image:url(${raceIcons[e.race]})"></div>
            <div class="icon" style="background-image:url(${initialClassData[e.class].icon})"></div>
            <div><strong>${e.name}</strong><br><small>${e.guild||""}</small></div>
            <div>${e.race}</div>
            <div>Lvl ${e.level}</div>
            <div class="class-name" style="color:${initialClassData[e.class].color}">${e.class}<br><small>${initialClassData[e.class].role}</small></div>
            ${snap.data?.role==="admin"?`<button onclick="deleteEntry('${doc.id}')">ðŸ—‘</button>`:""}`;
            list.appendChild(div);
        });
    });
}

/* DELETE ENTRY */
window.deleteEntry = async(id) => { if(confirm("Eintrag lÃ¶schen?")) await deleteDoc(doc(db,"entries",id)); };

/* ADMIN PANEL */
async function loadPending(){
    pendingList.innerHTML="";
    const q = await getDocs(collection(db,"users"));
    q.forEach(docu=>{
        const u = docu.data();
        if(u.role==="pending"){
            const div = document.createElement("div");
            div.className="adminUser";
            div.innerHTML=`${u.email} <button onclick="approveUser('${docu.id}')">Freischalten</button>`;
            pendingList.appendChild(div);
        }
    });
}

window.approveUser = async(uid) => { await updateDoc(doc(db,"users",uid),{role:"user"}); loadPending(); }

</script>
</body>
</html>
